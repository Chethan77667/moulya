{% extends "base.html" %}

{% block title %}Reports Dashboard - Academic Record Management System{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script defer>
    function initReportsForm() {
        return {
            selectedSubject: '',
            selectedCourse: '',
            selectedStudent: '',
            selectedMonth: new Date().getMonth() + 1,
            selectedYear: new Date().getFullYear(),
            selectedAssessmentType: '',
            selectedComprehensiveCourse: '',
            selectedReportType: 'attendance',
            studentSearch: '',
            showStudentDropdown: false,
            filteredStudents: [],
            allStudents: {{ students|tojson if students else '[]' }},
            selectedStudentCourse: '',
            
            init() {
                this.filteredStudents = this.allStudents.slice(0, 50); // Show first 50 initially
            },
            
            filterStudentsByCourse() {
                if (!this.selectedStudentCourse) {
                    this.filteredStudents = this.allStudents.slice(0, 50);
                    this.studentSearch = '';
                    this.selectedStudent = '';
                    return;
                }
                
                // Filter students by selected course
                const courseStudents = this.allStudents.filter(student => 
                    student.course_id == this.selectedStudentCourse
                );
                this.filteredStudents = courseStudents.slice(0, 50);
                this.studentSearch = '';
                this.selectedStudent = '';
            },
            
            filterStudents() {
                let baseStudents = this.selectedStudentCourse ? 
                    this.allStudents.filter(student => student.course_id == this.selectedStudentCourse) : 
                    this.allStudents;
                
                if (!this.studentSearch || this.studentSearch.length < 2) {
                    this.filteredStudents = baseStudents.slice(0, 50);
                    return;
                }
                
                const search = this.studentSearch.toLowerCase();
                const filtered = baseStudents.filter(student => 
                    student.name.toLowerCase().includes(search) || 
                    student.roll_number.toLowerCase().includes(search) ||
                    (student.course_name && student.course_name.toLowerCase().includes(search))
                );
                this.filteredStudents = filtered.slice(0, 50);
            },
            
            selectStudent(student) {
                this.selectedStudent = student.id;
                this.studentSearch = `${student.name} (${student.roll_number})`;
                this.showStudentDropdown = false;
            },
            
            generateStudentReport() {
                // Allow typing a roll number or name directly without clicking dropdown
                if (!this.selectedStudent) {
                    const input = (this.studentSearch || '').trim();
                    if (input) {
                        const lc = input.toLowerCase();
                        const matches = this.allStudents.filter(s => 
                            s.roll_number.toLowerCase() === lc ||
                            s.name.toLowerCase() === lc ||
                            s.roll_number.toLowerCase().includes(lc)
                        );
                        if (matches.length === 1) {
                            this.selectedStudent = matches[0].id;
                        }
                    }
                    if (!this.selectedStudent) {
                        Swal.fire('Error!', 'Please select a student', 'error');
                        return;
                    }
                }
                window.open(`/management/reports/student/${this.selectedStudent}`, '_blank');
            },
            
            generateClassMarksReport() {
                if (!this.selectedSubject) {
                    Swal.fire('Error!', 'Please select a subject', 'error');
                    return;
                }
                let url = `/management/reports/class/marks/${this.selectedSubject}`;
                if (this.selectedAssessmentType) {
                    url += `?assessment_type=${this.selectedAssessmentType}`;
                }
                window.open(url, '_blank');
            },
            
            generateClassAttendanceReport() {
                if (!this.selectedSubject) {
                    Swal.fire('Error!', 'Please select a subject', 'error');
                    return;
                }
                let url = `/management/reports/class/attendance/${this.selectedSubject}?month=${this.selectedMonth}&year=${this.selectedYear}`;
                window.open(url, '_blank');
            },
            
            generateCourseOverviewReport() {
                if (!this.selectedCourse) {
                    Swal.fire('Error!', 'Please select a course', 'error');
                    return;
                }
                window.open(`/management/reports/course/${this.selectedCourse}`, '_blank');
            },
            
            generateComprehensiveClassReport() {
                if (!this.selectedComprehensiveCourse) {
                    Swal.fire('Error!', 'Please select a course', 'error');
                    return;
                }
                if (!this.selectedReportType) {
                    Swal.fire('Error!', 'Please select a report type', 'error');
                    return;
                }
                let url = `/management/reports/comprehensive-class/${this.selectedComprehensiveCourse}?type=${this.selectedReportType}`;
                if (this.selectedReportType === 'marks' && this.selectedAssessmentType) {
                    url += `&assessment_type=${this.selectedAssessmentType}`;
                }
                window.open(url, '_blank');
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div x-data="initReportsForm()">
<div class="min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('management.dashboard') }}" class="text-sm text-gray-600 hover:text-black">‚Üê Dashboard</a>
                    <h1 class="text-xl font-semibold text-gray-900">Reports Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-700">{{ current_user.username }}</span>
                    <form method="POST" action="{{ url_for('auth.logout') }}" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="text-sm text-gray-600 hover:text-black">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Reports Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Student Report Card -->
            <div class="bg-white shadow rounded-lg border border-gray-200">
                <div class="px-6 py-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">üìä</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">Individual Student Report</h3>
                            <p class="text-sm text-gray-600">Detailed marks and attendance analysis</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Course (Optional)</label>
                            <select x-model="selectedStudentCourse" 
                                    @change="filterStudentsByCourse()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">All Courses</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700">Search Student</label>
                            <input type="text" 
                                   x-model="studentSearch" 
                                   @input="filterStudents()" 
                                   @focus="showStudentDropdown = true"
                                   placeholder="Type at least 2 characters to search by name or roll number..."
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                            
                            <!-- Searchable Dropdown -->
                            <div x-show="showStudentDropdown" 
                                 x-transition
                                 class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm"
                                 @mousedown.away="showStudentDropdown = false" 
                                 @keydown.escape.window="showStudentDropdown = false">
                                <template x-for="student in filteredStudents" :key="student.id">
                                    <div @click="selectStudent(student)" 
                                         class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-100">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="font-medium" x-text="student.name"></span>
                                                <span class="ml-2 text-blue-600 font-mono text-sm" x-text="`(${student.roll_number})`"></span>
                                            </div>
                                            <div class="text-xs text-gray-500" x-text="`Y${student.academic_year} S${student.current_semester}`"></div>
                                        </div>
                                        <div class="text-sm text-gray-500" x-text="student.course_name"></div>
                                    </div>
                                </template>
                                <div x-show="filteredStudents.length === 50 && studentSearch.length >= 2" class="px-3 py-2 text-sm text-gray-500 border-t">
                                    Showing first 50 results. Type more to narrow down...
                                </div>
                                <div x-show="filteredStudents.length === 0 && studentSearch.length >= 2" class="px-3 py-2 text-sm text-gray-500">
                                    No students found matching your search.
                                </div>
                                <div x-show="studentSearch.length < 2" class="px-3 py-2 text-sm text-gray-500">
                                    Type at least 2 characters to search...
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="generateStudentReport()" 
                                    class="flex-1 bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                View Report
                            </button>
                            <button @click="selectedStudent && (window.location.href = `/management/reports/export/student/${selectedStudent}`)" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                üì• Export Excel
                            </button>
                            <button @click="selectedStudent && (window.location.href = `/management/reports/export/student/${selectedStudent}/pdf`)" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                üßæ Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Marks Report Card -->
            <div class="bg-white shadow rounded-lg border border-gray-200">
                <div class="px-6 py-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">üìà</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">Class Marks Report</h3>
                            <p class="text-sm text-gray-600">Performance analysis for entire class</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Subject</label>
                            <select x-model="selectedSubject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">Choose a subject...</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }} ({{ subject.code }}) - {{ subject.course_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Assessment Type (Optional)</label>
                            <select x-model="selectedAssessmentType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">All Assessments</option>
                                <option value="internal1">Internal 1</option>
                                <option value="internal2">Internal 2</option>
                                <option value="assignment">Assignment</option>
                                <option value="project">Project</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="generateClassMarksReport()" 
                                    class="flex-1 bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                View Report
                            </button>
                            <button @click="selectedSubject && (window.location.href = `/management/reports/export/class/marks/${selectedSubject}${selectedAssessmentType ? '?assessment_type=' + selectedAssessmentType : ''}`)" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                üì• Export Excel
                            </button>
                            <button @click="selectedSubject && (window.location.href = `/management/reports/export/class/marks/${selectedSubject}${selectedAssessmentType ? '?assessment_type=' + selectedAssessmentType : ''}/pdf`)" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                üßæ Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Attendance Report Card -->
            <div class="bg-white shadow rounded-lg border border-gray-200">
                <div class="px-6 py-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">üìÖ</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">Class Attendance Report</h3>
                            <p class="text-sm text-gray-600">Attendance tracking and analysis</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Subject</label>
                            <select x-model="selectedSubject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">Choose a subject...</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }} ({{ subject.code }}) - {{ subject.course_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Month</label>
                                <select x-model="selectedMonth" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                    <option class="font-bold text-white bg-gray-900" value="overall">Overall</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Year</label>
                                <select x-model="selectedYear" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="generateClassAttendanceReport()" 
                                    class="flex-1 bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                View Report
                            </button>
                            <button @click="selectedSubject && (window.location.href = `/management/reports/export/class/attendance/${selectedSubject}?month=${selectedMonth}&year=${selectedYear}`)" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                üì• Export Excel
                            </button>
                            <button @click="selectedSubject && (window.location.href = `/management/reports/export/class/attendance/${selectedSubject}/pdf?month=${selectedMonth}&year=${selectedYear}`)" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                üßæ Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Overview Report Card -->
            <div class="bg-white shadow rounded-lg border border-gray-200">
                <div class="px-6 py-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">üéì</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">Course Overview Report</h3>
                            <p class="text-sm text-gray-600">Comprehensive overview of entire course</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Course</label>
                            <select x-model="selectedCourse" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">Choose a course...</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }} ({{ course.code }}) - {{ course.total_students }} students</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="generateCourseOverviewReport()" 
                                    class="flex-1 bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                View Report
                            </button>
                            <button @click="selectedCourse && (window.open(`/management/reports/export/course/${selectedCourse}`, '_blank'))" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                üì• Export Excel
                            </button>
                            <button @click="selectedCourse && (window.open(`/management/reports/export/course/${selectedCourse}/pdf`, '_blank'))" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                üßæ Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comprehensive Class Report Card -->
            <div class="bg-white shadow rounded-lg border border-gray-200">
                <div class="px-6 py-6">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 bg-gray-900 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">üìä</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-900">Comprehensive Class Report</h3>
                            <p class="text-sm text-gray-600">Complete attendance and marks analysis for all subjects</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Course</label>
                            <select x-model="selectedComprehensiveCourse" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="">Choose a course...</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }} ({{ course.code }}) - {{ course.total_students }} students</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Report Type</label>
                            <select x-model="selectedReportType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="attendance">Attendance Report</option>
                                <option value="marks">Marks Report</option>
                            </select>
                        </div>
                        
                        <div x-show="selectedReportType === 'marks'">
                            <label class="block text-sm font-medium text-gray-700">Assessment Type (Optional)</label>
                            <select x-model="selectedAssessmentType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                                <option value="all">All Assessments</option>
                                <option value="internal1">Internal 1</option>
                                <option value="internal2">Internal 2</option>
                                <option value="assignment">Assignment</option>
                                <option value="project">Project</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button @click="generateComprehensiveClassReport()" 
                                    class="flex-1 bg-black text-white px-4 py-2 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                View Report
                            </button>
                            <button @click="selectedComprehensiveCourse && (window.open(`/management/reports/export/comprehensive-class/${selectedComprehensiveCourse}/excel?type=${selectedReportType}&assessment_type=${selectedAssessmentType}`, '_blank'))" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                üì• Export Excel
                            </button>
                            <button @click="selectedComprehensiveCourse && (window.open(`/management/reports/export/comprehensive-class/${selectedComprehensiveCourse}/pdf?type=${selectedReportType}&assessment_type=${selectedAssessmentType}`, '_blank'))" 
                                    class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                üßæ Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Quick Statistics removed as requested #}
    </div>
</div>
</div>
{% endblock %}